<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="commu">

	<select id="getMedicalrecommend" resultType="facInfo">
		<![CDATA[
		select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from
		(select wel.facilityNo,wel.typeName,wel.facilityName,wel.cityloc,wel.address,wel.telnumber,wel.latitude,wel.longitude,wel.serviceScore, rownum "RNUM" from
		(select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from welfarefacilities where typeName = '노인의료복지시설' order by servicescore desc)wel)
		where RNUM <=5
		]]>
	</select>
	
	<select id="getMedicalList" resultType="facInfo">
		select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from welfarefacilities where typeName = '노인의료복지시설'
	</select>
	
	<select id="getMedicalListAjax" parameterType="facInfo" resultType="facInfo">
		select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from welfarefacilities where typeName = '노인의료복지시설' 
		and latitude between #{swLat} and #{neLat} and longitude between #{swLng} and #{neLng}
	</select>

	<select id="getElderlyhomerecommend" resultType="facInfo">
		<![CDATA[
		select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from
		(select wel.facilityNo,wel.typeName,wel.facilityName,wel.cityloc,wel.address,wel.telnumber,wel.latitude,wel.longitude,wel.serviceScore, rownum "RNUM" from
		(select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from welfarefacilities where typeName = '노인여가복지시설' order by servicescore desc)wel)
		where RNUM <=5
		]]>
	</select>
	
	<select id="getElderlyhomeList" resultType="facInfo">
		select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from welfarefacilities where typeName = '노인여가복지시설'
	</select>

	<select id="getSilverhallrecommend" resultType="facInfo">
		<![CDATA[
		select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from
		(select wel.facilityNo,wel.typeName,wel.facilityName,wel.cityloc,wel.address,wel.telnumber,wel.latitude,wel.longitude,wel.serviceScore, rownum "RNUM" from
		(select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from welfarefacilities where typeName = '재가노인복지시설' order by servicescore desc)wel)
		where RNUM <=5
		]]>
	</select>
	
	
	<select id="getSilverhallList" resultType="facInfo">
		select facilityNo,typeName,facilityName,cityloc,address,telnumber,latitude,longitude,serviceScore from welfarefacilities where typeName = '재가노인복지시설'
	</select>

	<resultMap type="facInfo" id="facInfo">
		<id property="facilityNo" column="facilityNo"/>
		<result property="facilityName" column="facilityName" />
		<result property="typeName" column="typeName" />
		<result property="cityloc" column="cityloc" />
		<result property="address" column="address" />
		<result property="telnumber" column="telnumber" />
		<result property="serviceScore" column="serviceScore" />
		<result property="latitude" column="latitude" />
		<result property="longitude" column="longitude" />
	<association property="medicalDetail" column="facilityNo" javaType="medicalDetail">
		<result property="facilityNo" column="facilityNo"/>
		<result property="peopleLimit" column="peopleLimit"/>
		<result property="peopleNumber" column="peopleNumber"/>
	</association>
	<association property="silverhallDetail" column="facilityNo" javaType="silverDetail">
		<result property="facilityNo" column="facilityNo"/>
		<result property="serviceType" column="serviceType"/>
	</association>
	</resultMap>
	<select id="facInfo" resultMap="facInfo">
		select
		w.facilityNo, w.facilityName, w.typeName,w.cityloc,w.address,w.telnumber,w.serviceScore,w.latitude,w.longitude,m.peopleLimit, m.peopleNumber, s.servicetype
		FROM welfarefacilities w, medicalDetail m, silverhalldetail s
		WHERE w.FACILITYNO = #{facilityNo}
		and w.facilityNo = m.facilityNo(+) and w.facilityNo = s.facilityNo(+)
	</select>
	
	<select id="reservationmember" resultType="mvo" parameterType="int">
		select u_no,u_id,u_name
		,'19'||to_date(u_birth,'yy-mm-dd') "u_birth"
		,decode(subStr(u_birth2,1,1),'1','남성','3','남성','여성') "u_gender"
        ,floor(to_number(sysdate-to_date(decode(substr(u_birth2,1,1),'1','19','2','19','20')||to_date(u_birth,'yy-mm-dd')))/365) "u_age"
		,u_phone,u_email,u_addr1||' '||u_addr2 "u_addr" from U_MEMBER where u_no = #{u_no}
	</select>
	
	<select id="welfareFacility" resultType="facInfo" parameterType="facInfo">
		select facilityNo,typeName,facilityName,address,telnumber from welfareFacilities where facilityNo = #{facilityNo}
	</select>
	
	<insert id="insertReservationInfo" parameterType="res">
		insert into reservationInfo VALUES((select nvl(max(resNo),0)+1 from reservationInfo),#{facilityNO}
		,#{facilityName},#{u_no},#{userName},#{userAge},to_date(#{resDate},'yyyy-mm-dd'),#{resTime}, #{visitPurpose})
	</insert>
	
	<update id="updateReservation" parameterType="res">
		update reservationInfo set resDate= to_date(#{resDate},'yyyy-mm-dd'), resTime = #{resTime}, visitPurpose = #{visitPurpose}  where resNO = #{resNo}
	</update>
	
	<delete id="reservationDelete" parameterType="res">
		delete reservationInfo where resNo = #{resNo}
	</delete>
	
	<resultMap type="res" id="res">
		<id property="resNo" column="resNo"/>
		<result property="facilityNO" column="facilityNO" />
		<result property="facilityName" column="facilityName" />
		<result property="u_no" column="u_no" />
		<result property="userName" column="userName" />
		<result property="userAge" column="userAge" />
		<result property="resDate" column="resDate" />
		<result property="resTime" column="resTime" />
		<result property="visitPurpose" column="visitPurpose" />
	<association property="welfareFacilitiesVO" column="facilityNo" javaType="facInfo">
		<id property="facilityNo" column="facilityNo"/>
		<result property="typeName" column="typeName"/>
		<result property="address" column="address"/>
		<result property="telnumber" column="telnumber"/>
	</association>
	<association property="memberVO" column="u_no" javaType="mvo">
		<result property="u_no" column="u_no"/>
		<result property="u_addr" column="u_addr"/>
		<result property="u_addr1" column="u_addr1"/>
		<result property="u_addr1" column="u_addr1"/>
		<result property="u_addr2" column="u_addr2"/>
		<result property="u_phone" column="u_phone"/>
		<result property="u_birth" column="u_birth"/>
		<result property="u_birth2" column="u_birth2"/>
		<result property="u_age" column="u_age"/>
		<result property="u_gender" column="u_gender"/>
	</association>
	</resultMap>
	<select id="getMyReservation" resultMap="res">
		select
		r.resNO, w.typeName, r.facilityName, w.address, w.telnumber, r.userName,
		to_char(r.resDate,'yyyy-mm-dd') "resDate", r.resTime, r.visitPurpose
		from reservationInfo r, welfareFacilities w, U_MEMBER u
		where r.u_no = #{u_no} and r.u_no = u.u_no and r.facilityNO = w.facilityNo
	</select>
	
	<select id="getMyReservationDetail" resultMap="res">
		select
		r.resNo, r.facilityName, r.facilityNO, w.typeName, w.address, w.telnumber, r.userName, r.visitPurpose,
		decode(substr(u_birth2,1,1),'1','19','2','19','20')||to_date(u.u_birth,'yy-mm-dd') "u_birth",
		floor(to_number(sysdate-to_date(decode(substr(u_birth2,1,1),'1','19','2','19','20')||to_date(u.u_birth,'yy-mm-dd')))/365) "u_age",
		u.u_addr1||' '||u.u_addr2 "u_addr", u_phone, decode(subStr(u.u_birth2,1,1),'1','남성','3','남성','여성') "u_gender", r.u_no 
		from reservationInfo r, welfareFacilities w, U_MEMBER u
		where r.resNo = #{resNo} and r.facilityNO = w.facilityNO and r.u_no = u.u_no
	</select>
	

</mapper>  